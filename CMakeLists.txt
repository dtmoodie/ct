cmake_minimum_required(VERSION 2.8)
project(ct CXX)
if(NOT MSVC)
  list(APPEND CMAKE_CXX_FLAGS "-std=c++11")
endif()
file(GLOB_RECURSE hdr "include/*.hpp")
include_directories("include")
find_package(Boost QUIET COMPONENTS unit_test_framework)
MACRO(SUBDIRLIST result curdir)
  FILE(GLOB children RELATIVE ${curdir} ${curdir}/*)
  SET(dirlist "")
  FOREACH(child ${children})
    IF(IS_DIRECTORY ${curdir}/${child})
      LIST(APPEND dirlist ${child})
    ENDIF()
  ENDFOREACH()
  SET(${result} ${dirlist})
ENDMACRO()

if(Boost_UNIT_TEST_FRAMEWORK_FOUND)
  include_directories(${Boost_INCLUDE_DIRS})
  include(CTest)
  enable_testing()
  SUBDIRLIST(tests "${CMAKE_CURRENT_LIST_DIR}/tests")
  foreach(test ${tests})
    file(GLOB_RECURSE test_srcs "tests/${test}/*.cpp")
    IF(CUDA_FOUND)
      file(GLOB_RECURSE test_knl "tests/${test}/*.cu")
    ENDIF()
    LIST(LENGTH test_knl num_knl)
    IF(${num_knl} GREATER 0)
      cuda_add_executable(${test} ${test_srcs} ${test_knl} ${hdr})
	else()
      add_executable(${test} ${test_srcs} ${hdr})
    endif()
    TARGET_LINK_LIBRARIES(${test} ${Boost_UNIT_TEST_FRAMEWORK_LIBRARY})
	if(OpenCV_FOUND)
	  TARGET_LINK_LIBRARIES(${test} ${OpenCV_LIBS})
	endif()
    
    set_target_properties(${test} PROPERTIES FOLDER Tests/MetaObject)
    add_test(${test} ${test})
  endforeach()
endif()
